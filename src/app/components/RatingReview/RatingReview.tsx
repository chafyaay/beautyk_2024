import { ActivityIndicator, View } from "react-native";
import {
  Avatar,
  Divider,
  Icon,
  MD2Colors,
  MD3Colors,
  Text,
} from "react-native-paper";
import { deviceWidth } from "../../utils/device";
import { useQuery } from "react-query";
import { GET_ALL_PRODUCT_REVIEWS } from "../../utils/api-calls";
import { ProductProps } from "../../utils/models";
import React, { useEffect, useState } from "react";
import RenderHtml from "react-native-render-html";
import moment from "moment";
import Svg, { G, Path } from "react-native-svg";
moment.locale("fr");

const StarRender = ({ width }) => (
  <View style={{ width: 180, marginTop: 10, marginBottom: 7 }}>
    <View
      style={{
        position: "absolute",
        width: width,
        overflow: "hidden",
      }}
    >
      <Svg width="180" height="36" viewBox="0 0 180 36">
        <Path
          d="M 99.06794738769531 33.07619857788086 L 90.75144958496094 28.26231002807617 L 90 27.82733345031738 L 89.24855041503906 28.26231002807617 L 80.93206024169922 33.07619476318359 L 82.73854827880859 23.15385627746582 L 82.88056945800781 22.37383270263672 L 82.31602478027344 21.81714248657227 L 75.23670959472656 14.8361988067627 L 84.79661560058594 13.57223796844482 L 85.62757110595703 13.46238136291504 L 85.96949768066406 12.69711875915527 L 90 3.676867246627808 L 94.03050231933594 12.69711875915527 L 94.37242889404297 13.46238136291504 L 95.20338439941406 13.57223796844482 L 104.763298034668 14.83619976043701 L 97.68399810791016 21.81714248657227 L 97.11945343017578 22.37383270263672 L 97.261474609375 23.15385627746582 L 99.06794738769531 33.07619857788086 Z M 63.06794357299805 33.07619857788086 L 54.7514533996582 28.26231002807617 L 54 27.82733345031738 L 53.2485466003418 28.26231002807617 L 44.93206405639648 33.07619476318359 L 46.73854827880859 23.15385627746582 L 46.88057327270508 22.37383270263672 L 46.31602478027344 21.81714248657227 L 39.2367057800293 14.8361988067627 L 48.7966194152832 13.57223796844482 L 49.62757110595703 13.46238136291504 L 49.96950149536133 12.69711875915527 L 54 3.676867246627808 L 58.03049850463867 12.69711875915527 L 58.37242889404297 13.46238136291504 L 59.2033805847168 13.57223796844482 L 68.76329803466797 14.83619976043701 L 61.68399810791016 21.81714248657227 L 61.11945343017578 22.37383270263672 L 61.261474609375 23.15385627746582 L 63.06794357299805 33.07619857788086 Z M 171.0679321289062 33.07619476318359 L 162.7514495849609 28.26231002807617 L 162 27.82733345031738 L 161.2485504150391 28.26231002807617 L 152.9320831298828 33.07619476318359 L 154.7385406494141 23.15385627746582 L 154.8805694580078 22.37383270263672 L 154.3160247802734 21.81714248657227 L 147.2367095947266 14.8361988067627 L 156.7966156005859 13.57223796844482 L 157.6275787353516 13.46238136291504 L 157.9694976806641 12.69711875915527 L 162 3.676860332489014 L 166.030517578125 12.69711875915527 L 166.3724517822266 13.46238136291504 L 167.2033996582031 13.57223796844482 L 176.7632904052734 14.83619785308838 L 169.6839752197266 21.81714248657227 L 169.1194305419922 22.37383270263672 L 169.2614593505859 23.15385627746582 L 171.0679321289062 33.07619476318359 Z M 135.0679321289062 33.07619476318359 L 126.7514495849609 28.26231002807617 L 126 27.82733345031738 L 125.2485504150391 28.26231002807617 L 116.9320602416992 33.07619476318359 L 118.7385482788086 23.15385627746582 L 118.8805694580078 22.37383270263672 L 118.3160247802734 21.81714248657227 L 111.2367095947266 14.8361988067627 L 120.7966156005859 13.57223796844482 L 121.627571105957 13.46238136291504 L 121.9694976806641 12.69711875915527 L 126 3.676867246627808 L 130.0305023193359 12.69711875915527 L 130.3724212646484 13.46238136291504 L 131.2033843994141 13.57223796844482 L 140.7632904052734 14.8361988067627 L 133.6839752197266 21.81714248657227 L 133.1194305419922 22.37383270263672 L 133.2614593505859 23.15385627746582 L 135.0679321289062 33.07619476318359 Z M 27.06793785095215 33.07619476318359 L 18.75145149230957 28.26231002807617 L 18 27.82733345031738 L 17.24854850769043 28.26231002807617 L 8.932063102722168 33.07619476318359 L 10.73854732513428 23.15385627746582 L 10.88057136535645 22.37383270263672 L 10.31602382659912 21.81714248657227 L 3.236706733703613 14.8361988067627 L 12.7966194152832 13.57223796844482 L 13.62757110595703 13.46238136291504 L 13.9694995880127 12.69711875915527 L 18 3.676867246627808 L 22.0305004119873 12.69711875915527 L 22.37242889404297 13.46238136291504 L 23.2033805847168 13.57223796844482 L 32.7632942199707 14.8361988067627 L 25.6839771270752 21.81714248657227 L 25.11942863464355 22.37383270263672 L 25.26145172119141 23.15385627746582 L 27.06793785095215 33.07619476318359 Z"
          fill={MD2Colors.yellow700}
        />
      </Svg>
    </View>
    <Svg width="180" height="36" viewBox="0 0 180 36">
      <Path
        d="M 169.0109710693359 30.15237045288086 L 167.5016937255859 21.86247444152832 L 173.5265655517578 15.9213342666626 L 165.3448791503906 14.839599609375 L 162 7.353756904602051 L 158.6551208496094 14.839599609375 L 150.4734344482422 15.9213342666626 L 156.4983062744141 21.86247444152832 L 154.9890289306641 30.15237045288086 L 162 26.09417533874512 L 169.0109710693359 30.15237045288086 M 133.0109710693359 30.15237045288086 L 131.5016937255859 21.86247444152832 L 137.5265655517578 15.9213342666626 L 129.3448791503906 14.839599609375 L 126 7.353756904602051 L 122.6551284790039 14.839599609375 L 114.4734344482422 15.9213342666626 L 120.4982986450195 21.86247444152832 L 118.9890365600586 30.15237045288086 L 126 26.09417533874512 L 133.0109710693359 30.15237045288086 M 97.01096343994141 30.15237045288086 L 95.50170135498047 21.86247444152832 L 101.5265655517578 15.9213342666626 L 93.34487152099609 14.839599609375 L 90 7.353756904602051 L 86.65512847900391 14.839599609375 L 78.47343444824219 15.9213342666626 L 84.49829864501953 21.86247444152832 L 82.98903656005859 30.15237045288086 L 90 26.09417533874512 L 97.01096343994141 30.15237045288086 M 61.01096725463867 30.15237045288086 L 59.50170135498047 21.86247444152832 L 65.52656555175781 15.9213342666626 L 57.34487533569336 14.839599609375 L 54 7.353756904602051 L 50.65512466430664 14.839599609375 L 42.47343444824219 15.9213342666626 L 48.49829864501953 21.86247444152832 L 46.98903274536133 30.15237045288086 L 54 26.09417533874512 L 61.01096725463867 30.15237045288086 M 25.01096534729004 30.15237045288086 L 23.50169944763184 21.86247444152832 L 29.52656364440918 15.9213342666626 L 21.34487533569336 14.839599609375 L 18 7.353756904602051 L 14.65512466430664 14.839599609375 L 6.473435878753662 15.9213342666626 L 12.49829959869385 21.86247444152832 L 10.98903369903564 30.15237045288086 L 18 26.09417533874512 L 25.01096534729004 30.15237045288086 M 173.1248931884766 36 L 162 29.56049919128418 L 150.8751068115234 36 L 153.2628021240234 22.88520050048828 L 144 13.75109958648682 L 156.6000061035156 12.08520030975342 L 162 0 L 167.3999938964844 12.08520030975342 L 180 13.75109958648682 L 170.7371978759766 22.88520050048828 L 173.1248931884766 36 Z M 137.1248931884766 36 L 126 29.56049919128418 L 114.8750991821289 36 L 117.2628021240234 22.88520050048828 L 108 13.75109958648682 L 120.5999984741211 12.08520030975342 L 126 0 L 131.3999938964844 12.08520030975342 L 144 13.75109958648682 L 134.7371978759766 22.88520050048828 L 137.1248931884766 36 Z M 101.1249008178711 36 L 90 29.56049919128418 L 78.87509918212891 36 L 81.26280212402344 22.88520050048828 L 72 13.75109958648682 L 84.59999847412109 12.08520030975342 L 90 0 L 95.40000152587891 12.08520030975342 L 108 13.75109958648682 L 98.73719787597656 22.88520050048828 L 101.1249008178711 36 Z M 65.12490081787109 36 L 54 29.56049919128418 L 42.87509918212891 36 L 45.26279830932617 22.88520050048828 L 36 13.75109958648682 L 48.59999847412109 12.08520030975342 L 54 0 L 59.40000152587891 12.08520030975342 L 72 13.75109958648682 L 62.73720169067383 22.88520050048828 L 65.12490081787109 36 Z M 29.12490081787109 36 L 18 29.56049919128418 L 6.875100135803223 36 L 9.262800216674805 22.88520050048828 L 0 13.75109958648682 L 12.60000038146973 12.08520030975342 L 18 0 L 23.39999961853027 12.08520030975342 L 36 13.75109958648682 L 26.7371997833252 22.88520050048828 L 29.12490081787109 36 Z"
        fill={MD2Colors.indigo700}
        opacity={0.5}
      />
    </Svg>
  </View>
);

export const RatingReview = ({ product }: any) => {
  const [ratingValue, setRatingValue] = useState(0);
  const [ratingReviewWidth, setRatingReviewWidth] = useState(0);

  const { data, isLoading } = useQuery(
    "GET_ALL_PRODUCT_REVIEWS",
    GET_ALL_PRODUCT_REVIEWS
  );

  const reviews = !!data
    ? data?.filter((item) => item.product_id === product.id)
    : [];

  useEffect(() => {
    if (reviews?.length > 0) {
      const ratingValue = reviews?.reduce((a, b) => (a += b["rating"]), 0);

      const productRatingValue = ratingValue / reviews.length;

      const value = (180 * productRatingValue) / 5;

      setRatingReviewWidth(value);
      setRatingValue(ratingValue / reviews?.length);
    }
  }, [data]);

  return (
    <View style={{ marginTop: 20 }}>
      <View
        style={{
          flex: 1,
          justifyContent: "center",
          alignItems: "center",
          borderRadius: 5,
          borderWidth: 1,
          borderColor: MD2Colors.indigo200,
          padding: 10,
        }}
      >
        <Text
          variant="titleLarge"
          style={{ color: MD2Colors.yellow700, fontWeight: "900" }}
        >
          {ratingValue.toFixed(1)}/5
        </Text>
        <Divider></Divider>
        <StarRender width={ratingReviewWidth} />
        <Text variant="bodyMedium" style={{ color: MD2Colors.indigo700 }}>
          {reviews?.length} Avis
        </Text>
      </View>

      {!!isLoading ? (
        <ActivityIndicator animating={true} color={MD2Colors.indigo50} />
      ) : (
        reviews?.map(
          ({
            review,
            reviewer,
            reviewer_avatar_urls,
            date_created,
            rating,
          }) => (
            <View>
              <Divider style={{ marginTop: 20, marginBottom: 20 }} />
              <View style={{ flexDirection: "row" }}>
                <Avatar.Image
                  size={24}
                  source={{ uri: reviewer_avatar_urls[24] }}
                />

                <View
                  style={{
                    backgroundColor: MD2Colors.grey100,
                    padding: 10,
                    borderRadius: 5,
                    marginLeft: 10,
                  }}
                >
                  <Text variant="labelLarge">
                    {reviewer} ({rating}
                    <Icon source="star" size={15} />)
                  </Text>

                  <RenderHtml
                    emSize={3}
                    contentWidth={deviceWidth}
                    source={{ html: review }}
                  />
                  <Text
                    style={{ color: MD2Colors.indigo500 }}
                    variant="bodySmall"
                  >
                    {moment(date_created).format("LL")}
                  </Text>
                </View>
              </View>
            </View>
          )
        )
      )}
    </View>
  );
};
